# Agent Architecture Visual Guide

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      User Message                           â”‚
â”‚           "AÃ±ade mantequilla a la lista"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AgentOrchestrator                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Check for pending confirmation                    â”‚   â”‚
â”‚  â”‚ 2. Classify intent                                   â”‚   â”‚
â”‚  â”‚ 3. Route to appropriate agent                        â”‚   â”‚
â”‚  â”‚ 4. Handle confirmation if needed                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 IntentClassifier                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ LLM-based classification                             â”‚   â”‚
â”‚  â”‚ Returns: (IntentType, confidence)                    â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚ NOTE   â†’ Save memory/fact                            â”‚   â”‚
â”‚  â”‚ TASK   â†’ Create/manage task                          â”‚   â”‚
â”‚  â”‚ LIST   â†’ Add/query list                              â”‚   â”‚
â”‚  â”‚ QUERY  â†’ Answer question                             â”‚   â”‚
â”‚  â”‚ UNKNOWN â†’ Ask clarification                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚           â”‚
        â–¼            â–¼            â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ListAgent  â”‚ â”‚TaskAgentâ”‚ â”‚NoteAgentâ”‚ â”‚QueryAgentâ”‚
â”‚             â”‚ â”‚         â”‚ â”‚         â”‚ â”‚          â”‚
â”‚ â€¢ add       â”‚ â”‚ â€¢ createâ”‚ â”‚ â€¢ save  â”‚ â”‚ â€¢ search â”‚
â”‚ â€¢ query     â”‚ â”‚ â€¢ query â”‚ â”‚         â”‚ â”‚ â€¢ composeâ”‚
â”‚ â€¢ remove    â”‚ â”‚ â€¢ complete â”‚       â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentResult                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ success: bool                                        â”‚   â”‚
â”‚  â”‚ message: str                                         â”‚   â”‚
â”‚  â”‚ needs_confirmation: bool                             â”‚   â”‚
â”‚  â”‚ preview: str | None                                  â”‚   â”‚
â”‚  â”‚ data: dict | None                                    â”‚   â”‚
â”‚  â”‚ error: str | None                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Needs            â”‚    â”‚ Direct Response      â”‚
â”‚ Confirmation?    â”‚    â”‚                      â”‚
â”‚                  â”‚    â”‚ "I found 3 memories  â”‚
â”‚ "Add milk to     â”‚    â”‚  about John..."      â”‚
â”‚  shopping list?" â”‚    â”‚                      â”‚
â”‚                  â”‚    â”‚ (Query operations)   â”‚
â”‚ [Yes] [No]       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚
    â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Yes   â”‚ â”‚   No    â”‚
â”‚        â”‚ â”‚         â”‚
â”‚Execute â”‚ â”‚ Cancel  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Intent Classification Flow

```
Message: "AÃ±ade mantequilla a la lista de la compra"
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   IntentClassifier    â”‚
         â”‚                       â”‚
         â”‚ Analyze keywords:     â”‚
         â”‚ â€¢ "AÃ±ade" = add       â”‚
         â”‚ â€¢ "lista" = list      â”‚
         â”‚                       â”‚
         â”‚ LLM Classification:   â”‚
         â”‚ Intent: LIST          â”‚
         â”‚ Confidence: 0.95      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Confidence Check     â”‚
         â”‚                       â”‚
         â”‚  0.95 >= 0.7? âœ…      â”‚
         â”‚  â†’ Route to ListAgent â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     ListAgent         â”‚
         â”‚                       â”‚
         â”‚ 1. Detect operation   â”‚
         â”‚    â†’ "add"            â”‚
         â”‚                       â”‚
         â”‚ 2. Extract items      â”‚
         â”‚    â†’ ["mantequilla"]  â”‚
         â”‚                       â”‚
         â”‚ 3. Extract list name  â”‚
         â”‚    â†’ "lista de la     â”‚
         â”‚       compra"         â”‚
         â”‚                       â”‚
         â”‚ 4. Create preview     â”‚
         â”‚    â†’ "Add mantequilla â”‚
         â”‚       to shopping     â”‚
         â”‚       list?"          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Return Result       â”‚
         â”‚                       â”‚
         â”‚ needs_confirmation:   â”‚
         â”‚   true                â”‚
         â”‚                       â”‚
         â”‚ preview:              â”‚
         â”‚   "ğŸ“‹ Add to lista de â”‚
         â”‚    la compra?         â”‚
         â”‚    â€¢ mantequilla"     â”‚
         â”‚                       â”‚
         â”‚ data:                 â”‚
         â”‚   {items: [...],      â”‚
         â”‚    list_name: "..."}  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Multi-Intent Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Example Messages                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

"AÃ±ade mantequilla a la lista"
    â†“ IntentClassifier â†’ LIST (0.95)
    â†“ ListAgent â†’ add operation
    â†“ Extract: ["mantequilla"], "lista de la compra"
    â†“ Preview â†’ "Add to shopping list?"
    â†“ Confirm â†’ Execute

"Remind me to call John tomorrow"
    â†“ IntentClassifier â†’ TASK (0.92)
    â†“ TaskAgent â†’ create operation
    â†“ Extract: title="Call John", due="tomorrow"
    â†“ Preview â†’ "Create task: Call John (Due: tomorrow)?"
    â†“ Confirm â†’ Execute

"Remember that John likes coffee"
    â†“ IntentClassifier â†’ NOTE (0.88)
    â†“ NoteAgent â†’ save operation
    â†“ Extract: content="John likes coffee", people=["John"]
    â†“ Preview â†’ "Save note about John?"
    â†“ Confirm â†’ Execute

"What did I save about John?"
    â†“ IntentClassifier â†’ QUERY (0.90)
    â†“ QueryAgent â†’ search operation
    â†“ Search memories for "John"
    â†“ Compose answer with sources
    â†“ Direct response (no confirmation)
```

## Agent Responsibility Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent    â”‚              Responsibilities                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ListAgent  â”‚ â€¢ Detect operation (add/query/remove)          â”‚
â”‚            â”‚ â€¢ Parse multiple items ("a, b and c")          â”‚
â”‚            â”‚ â€¢ Infer list names ("compra" â†’ "shopping")    â”‚
â”‚            â”‚ â€¢ Auto-create lists if not exist               â”‚
â”‚            â”‚ â€¢ Query list contents                          â”‚
â”‚            â”‚ â€¢ Tool: ListTool                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TaskAgent  â”‚ â€¢ Detect operation (create/query/complete)     â”‚
â”‚            â”‚ â€¢ Extract title, due date, priority            â”‚
â”‚            â”‚ â€¢ Parse natural dates ("tomorrow", "Friday")   â”‚
â”‚            â”‚ â€¢ List pending/completed tasks                 â”‚
â”‚            â”‚ â€¢ Tool: TaskTool                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NoteAgent  â”‚ â€¢ Extract note content                         â”‚
â”‚            â”‚ â€¢ Identify people, places, tags                â”‚
â”‚            â”‚ â€¢ Clean content (remove "remember", etc.)      â”‚
â”‚            â”‚ â€¢ Save to memory service                       â”‚
â”‚            â”‚ â€¢ Tool: MemoryService                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ QueryAgent â”‚ â€¢ Understand question intent                   â”‚
â”‚            â”‚ â€¢ Search vector memory                         â”‚
â”‚            â”‚ â€¢ Compose answer from sources                  â”‚
â”‚            â”‚ â€¢ Format with citations                        â”‚
â”‚            â”‚ â€¢ Tool: RetrievalCrew                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Confirmation Flow Detail

```
User: "Add milk to shopping list"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ListAgent.handle()                  â”‚
â”‚                                     â”‚
â”‚ 1. Extract: ["milk"], "shopping"   â”‚
â”‚ 2. Create preview                   â”‚
â”‚ 3. Return AgentResult:              â”‚
â”‚    needs_confirmation = True        â”‚
â”‚    preview = "ğŸ“‹ Add to shopping... â”‚
â”‚    data = {items, list_name}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator                        â”‚
â”‚                                     â”‚
â”‚ 1. Store in pending_confirmations  â”‚
â”‚    [chat_id] = {agent, data}        â”‚
â”‚ 2. Return preview to user           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show to User:                       â”‚
â”‚                                     â”‚
â”‚ "ğŸ“‹ Add to shopping list?           â”‚
â”‚  â€¢ milk                             â”‚
â”‚                                     â”‚
â”‚  Reply 'yes' to confirm"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
User: "yes"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator._handle_confirmation() â”‚
â”‚                                     â”‚
â”‚ 1. Get pending from chat_id         â”‚
â”‚ 2. Check if "yes" in message        â”‚
â”‚ 3. Call agent.execute_confirmed()   â”‚
â”‚ 4. Clear pending                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ListAgent.execute_confirmed()       â”‚
â”‚                                     â”‚
â”‚ 1. Get data from confirmation       â”‚
â”‚ 2. Call list_tool.add_item()        â”‚
â”‚ 3. Return success message           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show to User:                       â”‚
â”‚                                     â”‚
â”‚ "âœ… Added milk to shopping list"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
User: "uhm something unclear"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IntentClassifier                    â”‚
â”‚                                     â”‚
â”‚ LLM returns:                        â”‚
â”‚   Intent: UNKNOWN                   â”‚
â”‚   Confidence: 0.3                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator                        â”‚
â”‚                                     â”‚
â”‚ Check confidence: 0.3 < 0.7 âŒ      â”‚
â”‚ â†’ Build clarification message       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show to User:                       â”‚
â”‚                                     â”‚
â”‚ "I'm not sure what you want (30%).  â”‚
â”‚                                     â”‚
â”‚ Did you want to:                    â”‚
â”‚ â€¢ ğŸ“ Save a note?                   â”‚
â”‚ â€¢ âœ… Create a task?                 â”‚
â”‚ â€¢ ğŸ“‹ Add to a list?                 â”‚
â”‚ â€¢ â“ Ask a question?"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Persistence                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ListAgent
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ListTool      â”‚  â†’ lists.sqlite
â”‚                 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ add_item()    â”‚  â†’  â”‚ lists table  â”‚
â”‚ â€¢ get_items()   â”‚  â†  â”‚ items table  â”‚
â”‚ â€¢ remove_item() â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TaskAgent
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TaskTool      â”‚  â†’ tasks.sqlite
â”‚                 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ create_task() â”‚  â†’  â”‚ tasks table  â”‚
â”‚ â€¢ list_tasks()  â”‚  â†  â”‚              â”‚
â”‚ â€¢ complete()    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NoteAgent
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MemoryService   â”‚  â†’ vector database
â”‚                 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ add_memory()  â”‚  â†’  â”‚ embeddings   â”‚
â”‚ â€¢ search()      â”‚  â†  â”‚ metadata     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

QueryAgent
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RetrievalCrew   â”‚  â† vector database
â”‚                 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ search()      â”‚  â†  â”‚ embeddings   â”‚
â”‚ â€¢ compose()     â”‚  â†  â”‚ memories     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Code Structure Visual

```
src/app/agents/
â”‚
â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â””â”€â”€ Exports all agents
â”‚
â”œâ”€â”€ ğŸ“„ base.py
â”‚   â”œâ”€â”€ BaseAgent (abstract)
â”‚   â”‚   â”œâ”€â”€ can_handle()
â”‚   â”‚   â”œâ”€â”€ handle()
â”‚   â”‚   â””â”€â”€ execute_confirmed()
â”‚   â””â”€â”€ AgentResult (dataclass)
â”‚
â”œâ”€â”€ ğŸ“„ intent_classifier.py
â”‚   â”œâ”€â”€ IntentType (enum)
â”‚   â””â”€â”€ IntentClassifier
â”‚       â””â”€â”€ classify() â†’ (intent, confidence)
â”‚
â”œâ”€â”€ ğŸ“„ list_agent.py
â”‚   â””â”€â”€ ListAgent(BaseAgent)
â”‚       â”œâ”€â”€ _detect_operation() â†’ add/query/remove
â”‚       â”œâ”€â”€ _extract_items_and_list() â†’ LLM extraction
â”‚       â”œâ”€â”€ _parse_items_simple() â†’ regex fallback
â”‚       â”œâ”€â”€ _handle_add()
â”‚       â”œâ”€â”€ _handle_query()
â”‚       â””â”€â”€ execute_confirmed()
â”‚
â”œâ”€â”€ ğŸ“„ task_agent.py
â”‚   â””â”€â”€ TaskAgent(BaseAgent)
â”‚       â”œâ”€â”€ _detect_operation() â†’ create/query/complete
â”‚       â”œâ”€â”€ _extract_task_details() â†’ LLM extraction
â”‚       â”œâ”€â”€ _handle_create()
â”‚       â”œâ”€â”€ _handle_query()
â”‚       â””â”€â”€ execute_confirmed()
â”‚
â”œâ”€â”€ ğŸ“„ note_agent.py
â”‚   â””â”€â”€ NoteAgent(BaseAgent)
â”‚       â”œâ”€â”€ _extract_note_details() â†’ LLM extraction
â”‚       â””â”€â”€ execute_confirmed()
â”‚
â”œâ”€â”€ ğŸ“„ query_agent.py
â”‚   â””â”€â”€ QueryAgent(BaseAgent)
â”‚       â””â”€â”€ handle() â†’ search + compose (no confirmation)
â”‚
â””â”€â”€ ğŸ“„ orchestrator.py
    â””â”€â”€ AgentOrchestrator
        â”œâ”€â”€ handle_message()
        â”œâ”€â”€ _handle_confirmation()
        â””â”€â”€ _build_clarification_message()
```

## Comparison: Old vs New

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OLD SYSTEM                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Message
  â†“
Router (Phase 1)
  â”œâ”€â”€ ConversationIntent enum (underscores)
  â”œâ”€â”€ Keyword detection
  â””â”€â”€ Heuristics
  â†“
Planner (Phase 2)
  â”œâ”€â”€ IntentType enum (dots)
  â”œâ”€â”€ More heuristics
  â””â”€â”€ Examples
  â†“
Enricher
  â”œâ”€â”€ Add context
  â””â”€â”€ Prepare for execution
  â†“
Clarifier (if ambiguous)
  â”œâ”€â”€ Detect ambiguity
  â””â”€â”€ Ask questions
  â†“
Tool Caller
  â”œâ”€â”€ Map to tools
  â””â”€â”€ Execute
  â†“
Response

Issues: Two intent systems, many layers, complex, hard to maintain

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NEW SYSTEM                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Message
  â†“
IntentClassifier
  â”œâ”€â”€ Single LLM call
  â”œâ”€â”€ 4 clear intents
  â””â”€â”€ Confidence score
  â†“
Specialized Agent
  â”œâ”€â”€ Self-contained logic
  â”œâ”€â”€ LLM extraction
  â””â”€â”€ Direct tool calls
  â†“
Response (with optional confirmation)

Benefits: Single intent system, clear flow, easy to extend
```

## Performance Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Metric    â”‚  Old System  â”‚  New System  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLM Calls   â”‚ 3-5          â”‚ 1-2          â”‚
â”‚ Layers      â”‚ 5            â”‚ 2            â”‚
â”‚ Code Lines  â”‚ ~500+        â”‚ ~1,155       â”‚
â”‚ Complexity  â”‚ High         â”‚ Low          â”‚
â”‚ Latency     â”‚ ~2-3s        â”‚ ~1-2s        â”‚
â”‚ Debuggable  â”‚ Hard         â”‚ Easy         â”‚
â”‚ Extendable  â”‚ Hard         â”‚ Easy         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Legend:**
- âœ… Implemented and working
- â³ Partially implemented (some TODOs)
- âŒ Not implemented
- â†’ Data flow direction
- â†“ Process flow direction
